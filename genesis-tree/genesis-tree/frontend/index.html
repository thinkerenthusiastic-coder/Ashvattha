<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Genesis Tree ‚Äî Universal Human Lineage</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Crimson+Pro:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #0a0806;
  --bg2: #110e09;
  --bg3: #1a1510;
  --gold: #c9a84c;
  --gold2: #e8c97a;
  --gold3: #f5e4b0;
  --dim: #6b5a3a;
  --text: #d4c4a0;
  --text2: #8a7a5a;
  --border: rgba(201,168,76,0.15);
  --border2: rgba(201,168,76,0.3);
  --genesis: #3a6b8a;
  --genesis2: #5a9bc4;
  --red: #c45a3a;
  --green: #4a8a5a;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Crimson Pro', Georgia, serif;
  font-size: 17px;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Grain overlay */
body::before {
  content:'';
  position:fixed;
  inset:0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:9999;
  opacity:0.6;
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app { display:flex; height:100vh; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
#sidebar {
  width: 280px;
  min-width: 280px;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

#logo {
  padding: 28px 24px 20px;
  border-bottom: 1px solid var(--border);
}
#logo h1 {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  font-weight: 900;
  color: var(--gold);
  letter-spacing: 0.12em;
  text-transform: uppercase;
}
#logo p {
  font-size: 11px;
  color: var(--dim);
  letter-spacing: 0.05em;
  margin-top: 4px;
  font-style: italic;
}

/* Stats bar */
#stats-bar {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.stat {
  flex: 1;
  min-width: 60px;
  text-align: center;
}
.stat .val {
  font-family: 'Cinzel', serif;
  font-size: 15px;
  color: var(--gold2);
  font-weight: 600;
}
.stat .lbl {
  font-size: 9px;
  color: var(--dim);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

/* Nav menu */
#nav-menu {
  flex: 1;
  overflow-y: auto;
  padding: 12px 0;
}
#nav-menu::-webkit-scrollbar { width: 4px; }
#nav-menu::-webkit-scrollbar-track { background: transparent; }
#nav-menu::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

.nav-section {
  margin-bottom: 4px;
}
.nav-section-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  cursor: pointer;
  color: var(--text2);
  font-size: 13px;
  letter-spacing: 0.04em;
  transition: color 0.2s;
  user-select: none;
}
.nav-section-header:hover { color: var(--gold2); }
.nav-section-header .icon { font-size: 16px; }
.nav-section-header .label { flex:1; font-family: 'Cinzel', serif; font-size:11px; text-transform:uppercase; letter-spacing:0.1em; }
.nav-section-header .arrow { font-size:10px; transition: transform 0.2s; }
.nav-section-header.open .arrow { transform: rotate(90deg); }
.nav-section-header.active { color: var(--gold); }

.nav-sub {
  display: none;
  padding: 4px 0 8px;
}
.nav-sub.open { display: block; }

.nav-sub-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 7px 20px 7px 36px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text2);
  transition: all 0.15s;
  position: relative;
}
.nav-sub-item:hover { color: var(--gold2); background: rgba(201,168,76,0.04); }
.nav-sub-item.active {
  color: var(--gold);
  background: rgba(201,168,76,0.08);
}
.nav-sub-item .count {
  margin-left: auto;
  font-size: 10px;
  color: var(--dim);
  background: rgba(255,255,255,0.04);
  padding: 1px 6px;
  border-radius: 8px;
}

/* Activity feed */
#activity-panel {
  border-top: 1px solid var(--border);
  padding: 0;
  max-height: 180px;
  overflow: hidden;
}
#activity-header {
  padding: 10px 20px;
  font-family: 'Cinzel', serif;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--dim);
  display: flex;
  align-items: center;
  gap: 8px;
}
#activity-dot {
  width:6px; height:6px;
  border-radius:50%;
  background: var(--green);
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%,100% { opacity:1; }
  50% { opacity:0.3; }
}
#activity-feed {
  overflow-y: auto;
  max-height: 140px;
  padding: 0 0 8px;
}
#activity-feed::-webkit-scrollbar { width:3px; }
#activity-feed::-webkit-scrollbar-thumb { background: var(--border); }

.activity-item {
  padding: 6px 20px;
  font-size: 11px;
  color: var(--dim);
  border-left: 2px solid transparent;
  line-height: 1.4;
  animation: slideIn 0.3s ease;
}
@keyframes slideIn {
  from { opacity:0; transform:translateX(-8px); }
  to { opacity:1; transform:translateX(0); }
}
.activity-item.discovered { border-color: var(--green); }
.activity-item.linked { border-color: var(--gold); }
.activity-item.merged { border-color: var(--genesis2); }
.activity-item .time { color: var(--bg3); font-size:9px; }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Search bar */
#search-bar {
  padding: 20px 28px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 12px;
  align-items: center;
  background: var(--bg2);
}
#search-wrap {
  flex: 1;
  position: relative;
}
#search-input {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 4px;
  padding: 11px 16px 11px 40px;
  color: var(--text);
  font-family: 'Crimson Pro', serif;
  font-size: 16px;
  outline: none;
  transition: border-color 0.2s;
}
#search-input:focus { border-color: var(--gold); }
#search-input::placeholder { color: var(--dim); }
#search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--dim);
  font-size: 14px;
}
#search-results {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  right: 0;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 4px;
  z-index: 100;
  max-height: 320px;
  overflow-y: auto;
  display: none;
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
}
#search-results.open { display: block; }
.search-result-item {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  transition: background 0.15s;
}
.search-result-item:hover { background: rgba(201,168,76,0.06); }
.search-result-item .sri-name { color: var(--gold2); font-size:15px; }
.search-result-item .sri-meta { font-size: 11px; color: var(--dim); }
.search-result-item .sri-type {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: auto;
}
.type-human { background: rgba(74,138,90,0.15); color: var(--green); }
.type-mythological { background: rgba(201,168,76,0.12); color: var(--gold); }
.type-genesis { background: rgba(90,155,196,0.12); color: var(--genesis2); }

#add-btn {
  background: transparent;
  border: 1px solid var(--border2);
  color: var(--gold);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 10px 18px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
#add-btn:hover { background: rgba(201,168,76,0.08); border-color: var(--gold); }

/* ‚îÄ‚îÄ CONTENT AREA ‚îÄ‚îÄ */
#content {
  flex: 1;
  overflow-y: auto;
  padding: 28px;
}
#content::-webkit-scrollbar { width: 6px; }
#content::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* ‚îÄ‚îÄ CATEGORY VIEW ‚îÄ‚îÄ */
#category-view h2 {
  font-family: 'Cinzel', serif;
  font-size: 22px;
  color: var(--gold);
  margin-bottom: 6px;
  font-weight: 600;
}
#category-view .subtitle {
  color: var(--dim);
  font-style: italic;
  margin-bottom: 24px;
  font-size: 14px;
}

#persons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
}

.person-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}
.person-card::before {
  content:'';
  position:absolute;
  left:0; top:0; bottom:0;
  width:3px;
  background: var(--gold);
  opacity:0;
  transition: opacity 0.2s;
}
.person-card:hover { border-color: var(--border2); transform: translateY(-1px); }
.person-card:hover::before { opacity:1; }
.person-card.genesis-card::before { background: var(--genesis2); opacity:0.5; }
.person-card .pc-name { color: var(--gold2); font-size:15px; margin-bottom:4px; }
.person-card .pc-era { font-size: 11px; color: var(--dim); }
.person-card .pc-genesis {
  font-size: 9px;
  color: var(--genesis2);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-top: 6px;
}

/* ‚îÄ‚îÄ PERSON / TREE VIEW ‚îÄ‚îÄ */
#tree-view { max-width: 900px; margin: 0 auto; }

#person-header {
  display: flex;
  align-items: flex-start;
  gap: 24px;
  margin-bottom: 32px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--border);
}
#person-avatar {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: var(--bg3);
  border: 2px solid var(--border2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  flex-shrink: 0;
}
#person-info h2 {
  font-family: 'Cinzel', serif;
  font-size: 26px;
  color: var(--gold);
  font-weight: 600;
  margin-bottom: 8px;
}
.person-badges { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
.badge {
  font-size: 10px;
  padding: 2px 10px;
  border-radius: 12px;
  letter-spacing: 0.05em;
  text-transform: uppercase;
}
.badge-era { background: rgba(201,168,76,0.1); color: var(--gold); border: 1px solid var(--border2); }
.badge-type { background: rgba(74,138,90,0.1); color: var(--green); border: 1px solid rgba(74,138,90,0.2); }
.badge-type.myth { background: rgba(201,168,76,0.08); color: var(--gold2); }
.badge-genesis { background: rgba(90,155,196,0.1); color: var(--genesis2); border: 1px solid rgba(90,155,196,0.2); }

/* Tree sections */
.tree-section {
  margin-bottom: 32px;
}
.tree-section-title {
  font-family: 'Cinzel', serif;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--dim);
  margin-bottom: 14px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Ancestor chain */
.ancestor-chain {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.rel-node {
  display: flex;
  align-items: center;
  gap: 0;
  position: relative;
}
.rel-node .connector {
  width: 24px;
  text-align: center;
  color: var(--border2);
  font-size: 14px;
  flex-shrink: 0;
}

.rel-card {
  flex: 1;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 12px 16px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 14px;
}
.rel-card:hover { border-color: var(--border2); background: var(--bg3); }
.rel-card.branch-card { border-style: dashed; opacity: 0.75; }
.rel-card.branch-card:hover { opacity:1; }
.rel-card.genesis-link { border-color: rgba(90,155,196,0.2); }

.rel-card .rc-name { color: var(--gold2); font-size:15px; }
.rel-card .rc-meta { font-size:12px; color: var(--dim); margin-top:2px; }
.rel-card .rc-type { font-size:10px; color: var(--dim); }

.confidence-bar-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-left: auto;
}
.confidence-pct {
  font-family: 'Cinzel', serif;
  font-size: 12px;
  color: var(--gold);
  white-space: nowrap;
}
.confidence-bar {
  width: 48px;
  height: 3px;
  background: var(--bg3);
  border-radius: 2px;
  overflow: hidden;
}
.confidence-bar-fill {
  height: 100%;
  border-radius: 2px;
  background: linear-gradient(90deg, var(--red), var(--gold), var(--green));
}

.source-links { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
.source-link {
  font-size: 10px;
  color: var(--genesis2);
  text-decoration: none;
  display: flex;
  align-items: center;
  gap:4px;
}
.source-link:hover { color: var(--gold2); }

/* Alternates toggle */
.show-alternates {
  font-size: 11px;
  color: var(--dim);
  cursor: pointer;
  padding: 6px 16px;
  border-left: 2px solid var(--border);
  margin-left: 24px;
  margin-top: 4px;
  transition: color 0.2s;
}
.show-alternates:hover { color: var(--gold2); }

/* Children grid */
.children-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 10px;
}

/* ‚îÄ‚îÄ WELCOME / HOME ‚îÄ‚îÄ */
#home-view { max-width: 700px; margin: 40px auto; text-align: center; }
#home-view .big-title {
  font-family: 'Cinzel', serif;
  font-size: 42px;
  color: var(--gold);
  font-weight: 900;
  letter-spacing: 0.06em;
  margin-bottom: 16px;
  line-height: 1.1;
}
#home-view .tagline {
  font-size: 19px;
  color: var(--text2);
  font-style: italic;
  margin-bottom: 48px;
  line-height: 1.6;
}
.divider-ornament {
  color: var(--dim);
  letter-spacing: 0.5em;
  font-size: 14px;
  margin: 32px 0;
}
#home-view .progress-section {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 24px;
  margin-bottom: 24px;
}
#home-view .progress-section h3 {
  font-family: 'Cinzel', serif;
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--dim);
  margin-bottom: 16px;
}
#genesis-progress-bar {
  width: 100%;
  height: 6px;
  background: var(--bg3);
  border-radius: 3px;
  overflow: hidden;
  margin: 12px 0;
}
#genesis-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--genesis2), var(--gold));
  border-radius: 3px;
  transition: width 1s ease;
}
.progress-label { font-size:12px; color: var(--dim); }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
#modal-overlay {
  position:fixed; inset:0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display:none;
  align-items: center;
  justify-content: center;
}
#modal-overlay.open { display:flex; }
#modal {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-radius: 6px;
  padding: 32px;
  width: 480px;
  max-width: 90vw;
}
#modal h3 {
  font-family: 'Cinzel', serif;
  font-size: 18px;
  color: var(--gold);
  margin-bottom: 24px;
  font-weight: 600;
}
.form-group { margin-bottom: 18px; }
.form-group label {
  display:block;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--dim);
  margin-bottom: 8px;
}
.form-group input, .form-group select {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 4px;
  padding: 10px 14px;
  color: var(--text);
  font-family: 'Crimson Pro', serif;
  font-size: 16px;
  outline: none;
  transition: border-color 0.2s;
}
.form-group input:focus, .form-group select:focus { border-color: var(--gold); }
.form-group select option { background: var(--bg3); }
.modal-actions { display:flex; gap:12px; margin-top:24px; }
.btn-primary {
  flex:1;
  background: rgba(201,168,76,0.12);
  border: 1px solid var(--gold);
  color: var(--gold);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 12px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary:hover { background: rgba(201,168,76,0.2); }
.btn-secondary {
  background: transparent;
  border: 1px solid var(--border2);
  color: var(--dim);
  font-family: 'Cinzel', serif;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 12px 20px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-secondary:hover { color: var(--text); border-color: var(--text2); }

/* ‚îÄ‚îÄ NEW ADDITIONS ‚îÄ‚îÄ */
#new-view h2 {
  font-family: 'Cinzel', serif;
  font-size: 22px;
  color: var(--gold);
  margin-bottom: 6px;
}
#new-view .subtitle { color: var(--dim); font-style: italic; margin-bottom: 24px; font-size:14px; }
.activity-list { display:flex; flex-direction:column; gap:8px; }
.activity-full-item {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 14px 18px;
  display: flex;
  align-items: flex-start;
  gap: 14px;
}
.activity-full-item .action-icon { font-size: 20px; flex-shrink:0; margin-top:2px; }
.activity-full-item .aname { color: var(--gold2); font-size:15px; }
.activity-full-item .adetail { font-size: 12px; color: var(--dim); margin-top:3px; }
.activity-full-item .atime { font-size: 10px; color: var(--bg3); margin-top:5px; letter-spacing:0.04em; }

/* responsive */
@media (max-width: 768px) {
  #sidebar { display:none; }
  #content { padding: 16px; }
}
</style>
</head>
<body>
<div id="app">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="logo">
      <h1>Genesis Tree</h1>
      <p>Universal Human Lineage Graph</p>
    </div>

    <div id="stats-bar">
      <div class="stat">
        <div class="val" id="stat-persons">‚Äî</div>
        <div class="lbl">Persons</div>
      </div>
      <div class="stat">
        <div class="val" id="stat-genesis">‚Äî</div>
        <div class="lbl">Open Roots</div>
      </div>
      <div class="stat">
        <div class="val" id="stat-merges">‚Äî</div>
        <div class="lbl">Merges</div>
      </div>
    </div>

    <nav id="nav-menu">
      <div class="nav-section">
        <div class="nav-section-header" onclick="showHome()" id="nav-home">
          <span class="icon">üå≥</span>
          <span class="label">Home</span>
        </div>
      </div>
      <div class="nav-section">
        <div class="nav-section-header" onclick="showNewAdditions()" id="nav-new">
          <span class="icon">‚ú®</span>
          <span class="label">New Additions</span>
        </div>
      </div>
      <div id="categories-nav"></div>
    </nav>

    <div id="activity-panel">
      <div id="activity-header">
        <div id="activity-dot"></div>
        Agent Activity
      </div>
      <div id="activity-feed"></div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <div id="search-bar">
      <div id="search-wrap">
        <span id="search-icon">‚åï</span>
        <input id="search-input" type="text" placeholder="Search any person, deity, ancestor‚Ä¶" autocomplete="off"/>
        <div id="search-results"></div>
      </div>
      <button id="add-btn" onclick="openAddModal()">+ Add Person</button>
    </div>

    <div id="content">
      <div id="home-view"></div>
      <div id="category-view" style="display:none"></div>
      <div id="tree-view" style="display:none"></div>
      <div id="new-view" style="display:none"></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modal-overlay">
  <div id="modal">
    <h3>Add New Person</h3>
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="modal-name" placeholder="e.g. Nikola Tesla"/>
    </div>
    <div class="form-group">
      <label>Type</label>
      <select id="modal-type">
        <option value="human">Human</option>
        <option value="mythological">Mythological / Deity</option>
      </select>
    </div>
    <div class="form-group">
      <label>Era</label>
      <select id="modal-era">
        <option value="">Unknown</option>
        <option value="Mythological">Mythological</option>
        <option value="Ancient">Ancient (before 500 AD)</option>
        <option value="Medieval">Medieval (500‚Äì1500 AD)</option>
        <option value="Modern">Modern (1500+)</option>
      </select>
    </div>
    <div class="form-group">
      <label>Approx. Birth Year (negative = BCE)</label>
      <input type="number" id="modal-year" placeholder="e.g. 1856 or -356"/>
    </div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" onclick="submitAddPerson()">Create & Begin Research</button>
    </div>
  </div>
</div>

<script>
const API = '';  // same origin

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let currentView = 'home';
let stats = {};
let categories = [];

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
async function init() {
  await loadStats();
  await loadCategories();
  showHome();
  startActivityPoll();
  startStatsPoll();
}

// ‚îÄ‚îÄ‚îÄ API HELPERS ‚îÄ‚îÄ‚îÄ
async function api(path) {
  try {
    const r = await fetch(API + path);
    return await r.json();
  } catch(e) {
    console.error(e);
    return null;
  }
}

async function post(path, body) {
  try {
    const r = await fetch(API + path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    return await r.json();
  } catch(e) {
    console.error(e);
    return null;
  }
}

// ‚îÄ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ
async function loadStats() {
  const s = await api('/api/stats');
  if (!s) return;
  stats = s;
  document.getElementById('stat-persons').textContent = s.total_persons?.toLocaleString() || '0';
  document.getElementById('stat-genesis').textContent = s.unresolved_genesis_blocks?.toLocaleString() || '0';
  document.getElementById('stat-merges').textContent = s.merges_completed?.toLocaleString() || '0';
}

function startStatsPoll() {
  setInterval(loadStats, 15000);
}

// ‚îÄ‚îÄ‚îÄ CATEGORIES NAV ‚îÄ‚îÄ‚îÄ
async function loadCategories() {
  const cats = await api('/api/categories');
  if (!cats) return;
  categories = cats;

  // Group by parent
  const roots = cats.filter(c => !c.parent_category_id);
  const childMap = {};
  cats.filter(c => c.parent_category_id).forEach(c => {
    if (!childMap[c.parent_category_id]) childMap[c.parent_category_id] = [];
    childMap[c.parent_category_id].push(c);
  });

  const nav = document.getElementById('categories-nav');
  nav.innerHTML = roots.map(root => `
    <div class="nav-section" id="nav-sec-${root.id}">
      <div class="nav-section-header" onclick="toggleSection(${root.id})">
        <span class="icon">${root.icon || 'üìÇ'}</span>
        <span class="label">${root.name}</span>
        <span class="arrow">‚Ä∫</span>
      </div>
      <div class="nav-sub" id="nav-sub-${root.id}">
        ${(childMap[root.id] || []).map(child => `
          <div class="nav-sub-item" onclick="loadCategory(${child.id}, '${child.name}')" id="nav-item-${child.id}">
            <span>${child.icon || '¬∑'}</span>
            <span>${child.name}</span>
            ${child.person_count > 0 ? `<span class="count">${child.person_count}</span>` : ''}
          </div>
        `).join('')}
        <div class="nav-sub-item" onclick="loadCategory(${root.id}, '${root.name}')">
          <span>¬∑¬∑¬∑</span>
          <span style="font-style:italic">All ${root.name}</span>
        </div>
      </div>
    </div>
  `).join('');
}

function toggleSection(id) {
  const sub = document.getElementById(`nav-sub-${id}`);
  const header = document.querySelector(`#nav-sec-${id} .nav-section-header`);
  sub.classList.toggle('open');
  header.classList.toggle('open');
}

// ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ
function showView(name) {
  ['home-view','category-view','tree-view','new-view'].forEach(v => {
    document.getElementById(v).style.display = 'none';
  });
  document.getElementById(name + '-view').style.display = 'block';
  currentView = name;
}

function showHome() {
  showView('home');
  renderHome();
}

async function renderHome() {
  const s = await api('/api/stats') || {};
  const coverage = s.coverage_pct || 0;
  document.getElementById('home-view').innerHTML = `
    <div style="max-width:680px; margin:0 auto; text-align:center; padding:20px 0">
      <div class="big-title">Every Being,<br/>One Tree</div>
      <div class="tagline">
        Connecting gods, ancients, and modern humans<br/>
        through a single unbroken lineage graph.
      </div>
      <div class="divider-ornament">‚Äî ‚ú¶ ‚Äî</div>
      <div class="progress-section">
        <h3>Graph Progress</h3>
        <div style="display:flex; justify-content:space-between; margin-bottom:8px">
          <span style="font-family:'Cinzel',serif; font-size:28px; color:var(--gold)">${(s.total_persons||0).toLocaleString()}</span>
          <span style="font-family:'Cinzel',serif; font-size:28px; color:var(--genesis2)">${(s.unresolved_genesis_blocks||0).toLocaleString()}</span>
        </div>
        <div style="display:flex; justify-content:space-between">
          <span class="progress-label">Persons indexed</span>
          <span class="progress-label">Open genesis blocks</span>
        </div>
        <div id="genesis-progress-bar" style="margin-top:16px">
          <div id="genesis-progress-fill" style="width:${coverage}%"></div>
        </div>
        <div class="progress-label" style="margin-top:8px">${coverage}% connected ‚Ä¢ ${(s.merges_completed||0)} genesis blocks resolved</div>
      </div>
      <div class="divider-ornament">‚Äî ‚ú¶ ‚Äî</div>
      <p style="color:var(--dim); font-style:italic; font-size:15px; line-height:1.8">
        The agent works endlessly ‚Äî discovering ancestors, linking descendants,<br/>
        resolving genesis blocks into the ever-growing tree.
      </p>
    </div>
  `;
}

async function loadCategory(catId, catName) {
  showView('category');
  document.getElementById('category-view').innerHTML = `
    <h2>${catName}</h2>
    <p class="subtitle">Loading‚Ä¶</p>
    <div id="persons-grid"></div>
  `;

  // Mark active nav item
  document.querySelectorAll('.nav-sub-item').forEach(el => el.classList.remove('active'));
  const navItem = document.getElementById(`nav-item-${catId}`);
  if (navItem) navItem.classList.add('active');

  const persons = await api(`/api/categories/${catId}/persons?limit=100`);
  if (!persons) return;

  const cat = categories.find(c => c.id == catId);
  document.getElementById('category-view').innerHTML = `
    <h2>${cat?.icon || ''} ${catName}</h2>
    <p class="subtitle">${persons.length} persons indexed ‚Äî agent adding more continuously</p>
    <div id="persons-grid"></div>
  `;

  const grid = document.getElementById('persons-grid');
  if (persons.length === 0) {
    grid.innerHTML = `<p style="color:var(--dim); font-style:italic">No persons yet in this category. The agent will populate it soon.</p>`;
    return;
  }

  grid.innerHTML = persons.map(p => `
    <div class="person-card ${p.is_genesis ? 'genesis-card' : ''}" onclick="loadPerson(${p.id})">
      <div class="pc-name">${p.name}</div>
      <div class="pc-era">${p.era || ''} ${p.approx_birth_year ? formatYear(p.approx_birth_year) : ''}</div>
      ${p.is_genesis ? `<div class="pc-genesis">‚¨° Open Root ${p.genesis_code || ''}</div>` : ''}
    </div>
  `).join('');
}

async function loadPerson(personId) {
  showView('tree');
  document.getElementById('tree-view').innerHTML = `<p style="color:var(--dim)">Loading tree‚Ä¶</p>`;

  const [person, tree] = await Promise.all([
    api(`/api/persons/${personId}`),
    api(`/api/persons/${personId}/tree?depth=4`)
  ]);

  if (!person) {
    document.getElementById('tree-view').innerHTML = `<p style="color:var(--red)">Person not found.</p>`;
    return;
  }

  const typeIcon = { human: 'üë§', mythological: '‚ö°', genesis: '‚¨°' }[person.type] || 'üë§';

  let html = `
    <div id="person-header">
      <div id="person-avatar">${typeIcon}</div>
      <div id="person-info">
        <h2>${person.name}</h2>
        <div class="person-badges">
          ${person.era ? `<span class="badge badge-era">${person.era}</span>` : ''}
          <span class="badge badge-type ${person.type === 'mythological' ? 'myth' : ''}">${person.type}</span>
          ${person.is_genesis ? `<span class="badge badge-genesis">‚¨° Open Root ${person.genesis_code || ''}</span>` : ''}
          ${person.approx_birth_year ? `<span class="badge badge-era">${formatYear(person.approx_birth_year)}</span>` : ''}
        </div>
        ${(person.categories||[]).map(c => `<span style="font-size:12px; color:var(--dim); margin-right:8px">${c.icon} ${c.name}</span>`).join('')}
      </div>
    </div>
  `;

  // Ancestors section
  if (tree) {
    html += renderAncestors(tree);
    html += renderDescendants(tree);
  }

  document.getElementById('tree-view').innerHTML = html;
}

function renderAncestors(node) {
  const parents = node.parents || [];
  if (parents.length === 0) return '';

  // Separate primary and branches
  const primaries = parents.filter(p => p.is_primary);
  const branches = parents.filter(p => !p.is_primary);

  let html = `<div class="tree-section">
    <div class="tree-section-title">‚Üë Ancestors</div>
    <div class="ancestor-chain">`;

  // Father
  const father = primaries.find(p => p.parent_type === 'father');
  const altFathers = [...primaries.filter(p => p.parent_type === 'father' && p !== father),
                      ...branches.filter(p => p.parent_type === 'father')];

  if (father) {
    html += renderRelCard(father, 'Father');
    if (altFathers.length > 0) {
      html += `<div class="show-alternates" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
        + ${altFathers.length} alternate branch(es)
      </div>
      <div style="display:none">
        ${altFathers.map(a => renderRelCard(a, 'Alt. Father', true)).join('')}
      </div>`;
    }
  }

  // Mother
  const mother = primaries.find(p => p.parent_type === 'mother');
  const altMothers = branches.filter(p => p.parent_type === 'mother');

  if (mother) {
    html += renderRelCard(mother, 'Mother');
    if (altMothers.length > 0) {
      html += `<div class="show-alternates" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
        + ${altMothers.length} alternate branch(es)
      </div>
      <div style="display:none">
        ${altMothers.map(a => renderRelCard(a, 'Alt. Mother', true)).join('')}
      </div>`;
    }
  }

  // Grandparents (from father's tree)
  if (father?.person?.parents?.length > 0) {
    html += `<div style="margin-left:24px; margin-top:8px">
      <div style="font-size:10px; color:var(--dim); padding:4px 0; text-transform:uppercase; letter-spacing:0.1em">Paternal Grandparents</div>
      ${father.person.parents.filter(p=>p.is_primary).map(gp => renderRelCard(gp, gp.parent_type === 'father' ? 'Grandfather' : 'Grandmother')).join('')}
    </div>`;
  }

  html += `</div></div>`;
  return html;
}

function renderRelCard(rel, label, isBranch = false) {
  const conf = parseFloat(rel.confidence || 0);
  const confColor = conf >= 90 ? 'var(--green)' : conf >= 70 ? 'var(--gold)' : 'var(--red)';
  const isGenesis = rel.is_genesis;
  const sources = (rel.sources || []).filter(Boolean);

  return `
    <div class="rel-node">
      <div class="connector">‚Ä∫</div>
      <div class="rel-card ${isBranch ? 'branch-card' : ''} ${isGenesis ? 'genesis-link' : ''}"
           onclick="loadPerson(${rel.parent_id})">
        <div>
          <div class="rc-type" style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:0.06em">${label}</div>
          <div class="rc-name">${rel.parent_name} ${isGenesis ? `<span style="color:var(--genesis2); font-size:11px">‚¨° ${rel.genesis_code||''}</span>` : ''}</div>
          <div class="rc-meta">${rel.era || ''}</div>
          ${sources.length > 0 ? `<div class="source-links">
            ${sources.slice(0,2).map(s => `<a class="source-link" href="${s}" target="_blank" onclick="event.stopPropagation()">üîó source</a>`).join('')}
          </div>` : ''}
        </div>
        <div class="confidence-bar-wrap">
          <div>
            <div class="confidence-bar">
              <div class="confidence-bar-fill" style="width:${conf}%; background: linear-gradient(90deg, var(--red), ${confColor})"></div>
            </div>
            <div class="confidence-pct" style="color:${confColor}">${conf.toFixed(0)}%</div>
          </div>
        </div>
      </div>
    </div>`;
}

function renderDescendants(node) {
  const children = node.children || [];
  if (children.length === 0) return '';

  return `<div class="tree-section">
    <div class="tree-section-title">‚Üì Descendants (${children.length})</div>
    <div class="children-grid">
      ${children.map(c => `
        <div class="person-card" onclick="loadPerson(${c.child_id})">
          <div class="pc-name">${c.child_name}</div>
          <div class="confidence-bar-wrap" style="margin-top:6px">
            <div class="confidence-bar" style="width:100%">
              <div class="confidence-bar-fill" style="width:${c.confidence}%"></div>
            </div>
            <span class="confidence-pct" style="font-size:11px">${parseFloat(c.confidence).toFixed(0)}%</span>
          </div>
        </div>
      `).join('')}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ NEW ADDITIONS VIEW ‚îÄ‚îÄ‚îÄ
async function showNewAdditions() {
  showView('new');
  const activity = await api('/api/activity?limit=100');
  if (!activity) return;

  const icons = { discovered: 'üîç', linked: 'üîó', merged: '‚ö°', created: '‚ú®', failed: '‚úó' };

  document.getElementById('new-view').innerHTML = `
    <h2>‚ú® New Additions</h2>
    <p class="subtitle">Live feed of agent discoveries ‚Äî refreshes every 10 seconds</p>
    <div class="activity-list">
      ${activity.map(a => `
        <div class="activity-full-item">
          <div class="action-icon">${icons[a.action] || '¬∑'}</div>
          <div>
            <div class="aname">${a.person_name || 'Unknown'}</div>
            <div class="adetail">${a.detail || ''}</div>
            <div class="atime">${new Date(a.logged_at).toLocaleString()}</div>
          </div>
          ${a.person_id ? `<button onclick="loadPerson(${a.person_id})" style="margin-left:auto; background:transparent; border:1px solid var(--border2); color:var(--gold); font-family:'Cinzel',serif; font-size:9px; text-transform:uppercase; letter-spacing:0.08em; padding:6px 12px; border-radius:4px; cursor:pointer">View</button>` : ''}
        </div>
      `).join('')}
    </div>
  `;

  setTimeout(() => {
    if (currentView === 'new') showNewAdditions();
  }, 10000);
}

// ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ
let searchTimeout;
const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');

searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  const q = searchInput.value.trim();
  if (q.length < 2) { searchResults.classList.remove('open'); return; }
  searchTimeout = setTimeout(() => doSearch(q), 300);
});

searchInput.addEventListener('keydown', e => {
  if (e.key === 'Escape') { searchResults.classList.remove('open'); searchInput.blur(); }
});

document.addEventListener('click', e => {
  if (!e.target.closest('#search-wrap')) searchResults.classList.remove('open');
});

async function doSearch(q) {
  const results = await api(`/api/persons/search?q=${encodeURIComponent(q)}&limit=10`);
  if (!results) return;

  if (results.length === 0) {
    searchResults.innerHTML = `<div style="padding:16px; color:var(--dim); font-style:italic">No results. Add this person?</div>`;
  } else {
    searchResults.innerHTML = results.map(p => `
      <div class="search-result-item" onclick="loadPerson(${p.id}); searchResults.classList.remove('open'); searchInput.value=''">
        <div>
          <div class="sri-name">${p.name}</div>
          <div class="sri-meta">${p.era || ''} ${p.approx_birth_year ? formatYear(p.approx_birth_year) : ''}</div>
        </div>
        <span class="sri-type type-${p.type}">${p.type}</span>
      </div>
    `).join('');
  }
  searchResults.classList.add('open');
}

// ‚îÄ‚îÄ‚îÄ ADD PERSON MODAL ‚îÄ‚îÄ‚îÄ
function openAddModal() {
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('modal-name').focus();
}
function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
}

async function submitAddPerson() {
  const name = document.getElementById('modal-name').value.trim();
  if (!name) return;
  const type = document.getElementById('modal-type').value;
  const era = document.getElementById('modal-era').value;
  const year = document.getElementById('modal-year').value;

  const result = await post('/api/persons', {
    name, type, era: era || null,
    approx_birth_year: year ? parseInt(year) : null
  });

  closeModal();
  if (result?.id) {
    loadPerson(result.id);
  }
}

// ‚îÄ‚îÄ‚îÄ ACTIVITY FEED ‚îÄ‚îÄ‚îÄ
async function startActivityPoll() {
  await pollActivity();
  setInterval(pollActivity, 5000);
}

async function pollActivity() {
  const activity = await api('/api/activity?limit=8');
  if (!activity) return;
  const feed = document.getElementById('activity-feed');
  const icons = { discovered: 'üîç', linked: 'üîó', merged: '‚ö°', created: '‚ú®' };
  feed.innerHTML = activity.map(a => `
    <div class="activity-item ${a.action}">
      ${icons[a.action] || '¬∑'} <strong style="color:var(--text)">${a.person_name || '?'}</strong>
      <br/><span>${a.detail?.substring(0,60) || ''}</span>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ
function formatYear(y) {
  if (!y) return '';
  return y < 0 ? `${Math.abs(y)} BCE` : `${y} AD`;
}

// Modal close on overlay click
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
});

// ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
